---
title: åŒ—æ–—å«æ˜Ÿå®šä½--5--äºŒé˜¶é”é¢‘ç¯è·¯
date: 2021-11-24 10:59:49
tags: ["SDR", "Matlab"]
categories: SDR
comment: true
mathjax: true
---
åœ¨å‰é¢çš„ä¸€æ®µæ—¶é—´çš„å­¦ä¹ å½“ä¸­ï¼Œå­¦ä¹ äº†å¦‚ä½•å¯¹ä¿¡å·è¿›è¡Œæ•è·ã€‚åœ¨GPSæ¥æ”¶æœºå½“ä¸­ï¼Œæ•è·åˆ°ä¿¡å·ä¹‹åï¼Œæ¥ä¸‹æ¥çš„æ“ä½œå°±æ˜¯å¯¹æ•è·åˆ°çš„ä¿¡å·è¿›è¡Œè·Ÿè¸ªå¤„ç†äº†ï¼Œåœ¨æ¥æ”¶æœºå½“ä¸­ï¼Œå¸¸è§çš„åŒæ­¥æ–¹æ³•æœ‰PLLï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä½¿å¾—æœ¬åœ°ç”Ÿæˆçš„è½½æ³¢èƒ½å¤Ÿè·Ÿè¸ªæ¥å—åˆ°çš„ä¿¡å·çš„é¢‘ç‡å’Œç›¸ä½çš„å˜åŒ–ï¼Œä»è€Œè¾¾åˆ°ç›¸å¹²è§£è°ƒçš„ç›®çš„ã€‚
<!--more-->
# é”ç›¸ç¯ç»“æ„ 
ä¸€ä¸ªå¸¸è§çš„é”ç›¸ç¯è·¯çš„ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![é”ç›¸ç¯çš„ç»“æ„](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/pll.png)

ä¿¡å·ç»è¿‡é€šè¿‡ä¸NCOäº§ç”Ÿçš„æœ¬åœ°è½½æ³¢è¿›è¡Œæ··é¢‘ï¼Œä»è€Œå¾—åˆ°åŸºå¸¦ä¿¡å·å’Œé«˜é¢‘åˆ†é‡ï¼Œä¿¡å·ç»è¿‡æ··é¢‘ä¹‹åï¼Œéœ€è¦ç»è¿‡ä¸€ä¸ªä½é€šæ»¤æ³¢å™¨å°†é«˜é¢‘åˆ†é‡æ»¤é™¤ã€‚
åœ¨ä¸Šé¢æ‰€ç¤ºçš„å›¾ä¸­é‡‡ç”¨çš„æ˜¯ä¸€ä¸ªå‡å€¼æ»¤æ³¢å™¨ï¼Œå‡å€¼æ»¤æ³¢æ˜¯ä¸€ç§ç®€å•çš„ä½é€šæ»¤æ³¢å™¨ï¼Œå®ç°åœ¨ä¸€æ®µæ—¶é—´å†…å¯¹è¾“å…¥çš„ä¿¡å·è¿›è¡Œæ±‚å’Œå¹¶æ±‚å¾—å¹³å‡å€¼çš„æ“ä½œï¼Œä»è€Œæ»¤é™¤é«˜é¢‘åˆ†é‡ã€‚
ä¿¡å·ç„¶åå†ç»è¿‡PLLå®Œæˆä¿¡å·çš„è¿½è¸ªå’Œé”å®šã€‚ä¸€ä¸ªå¸¸è§çš„PLLçš„ç»“åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯é‰´ç›¸å™¨ã€ç¯è·¯æ»¤æ³¢å™¨å’ŒNCOã€‚


# é‰´ç›¸å™¨
## å¸¸è§„é‰´ç›¸å™¨

![å¸¸è§„PLL.png](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/åŸºæœ¬PLL.png)

å¸¸è§„çš„é‰´ç›¸å™¨å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªç®€å•çš„ä¹˜æ³•å™¨,å‡å®šè¾“å…¥çš„ä¿¡å·ä¸ºï¼š

$$u_{i}(t)=U_{i}sin(w_{i}t+\theta_{i})$$

å‡è®¾ç»è¿‡ç¯è·¯æ»¤æ³¢å™¨çš„è¾“å‡ºä¿¡å·ä¸º

$$u_{o}(t)=U_{o}cos(w_{o}t+ \theta_{o})$$

é‚£ä¹ˆç»è¿‡é‰´ç›¸å™¨ä¹‹åçš„ç»“æœä¸º

$$u_{d}(t) = u_{i}(t)u_{o}(t) = U_{i}U_{o}sinâ¡(Ï‰_{i}t+Î¸_{i})cosâ¡(â¡(Ï‰_{o}t+Î¸_{o}))$$

$$=K_{d}{sin[(Ï‰_{i}+Ï‰_{o})t+Î¸_{i}+ Î¸_{o}]+sin[(Ï‰_{i}-Ï‰_{o})t+Î¸_{i}-Î¸_{o}]}$$

å¯ä»¥çœ‹åˆ°ï¼Œä¸¤è€…ç›¸ä¹˜ä¹‹åå¾—åˆ°é«˜é¢‘åˆ†é‡å’Œä½é¢‘åˆ†é‡ï¼Œä½¿ç”¨æ»¤æ³¢å™¨å¯ä»¥æ»¤é™¤é«˜é¢‘åˆ†é‡ï¼Œç”±äºä½¿ç”¨PLLä¿¡å·ä¹‹åï¼Œä»NCOä¸­è¾“å‡ºçš„ä¿¡å·çš„é¢‘ç‡å’Œç›¸ä½åº”è¯¥å’Œè¾“å…¥çš„ä¿¡å·ååˆ†æ¥è¿‘ï¼Œå› æ­¤ç»è¿‡ä½é€šæ»¤æ³¢å™¨ä¹‹åå¯ä»¥å¾—åˆ°çš„ä½é¢‘åˆ†é‡å¦‚ä¸‹ï¼š

$$u_{f}(t)= K_{d}sin[(Ï‰_{i}-Ï‰_{o})t+Î¸_{i}-Î¸_{o}], K_{d}= \frac{1}{2}U_{i}U_{o}$$

$$u_{f}(t)= K_{d}K_{f}sin(Î¸_{i}-Î¸_{o})$$

$$u_{f}(t)\approx K_{d}K_{f}Î¸_{e}$$

å…¶ä¸­ 
$$Î¸_{e}=sin(Î¸_{i}-Î¸_{o})$$
è¿™ä¸ªåªæœ‰åœ¨NCOè¾“å‡ºçš„è½½æ³¢é¢‘ç‡å’Œè¾“å…¥ä¿¡å·è½½æ³¢é¢‘ç‡å¾ˆå°çš„æ—¶å€™ï¼Œæ‰å¯ä»¥ä½¿ç”¨è¿™ç§è¿‘ä¼¼ã€‚

## IQè§£è°ƒé‰´ç›¸å™¨
åœ¨æœ€å¼€å§‹çœ‹åˆ°çš„å¯¹äºIQè§£è°ƒçš„ç³»ç»Ÿå½“ä¸­ï¼Œé‰´ç›¸å™¨çš„ç»“æ„ä¹Ÿå’Œä¸Šé¢çš„ç»“æ„ç±»ä¼¼ã€‚å‡è®¾è¾“å…¥çš„ä¿¡å·ä¸º
$$u_{i}(t)=D(t)sin(w_{i}t+\theta_{i})$$
ç”±æœ¬åœ°äº§ç”Ÿçš„è½½æ³¢åˆ†åˆ«ä¸ºï¼š
$$u_{oi}(t)=cos(w_{o}t+\theta_{o})$$

$$u_{oq}(t)=sin(w_{o}t+\theta_{o})$$
ä½¿ç”¨æ­£äº¤è§£è°ƒä¹‹åç»è¿‡ä½é€šæ»¤æ³¢å™¨å¾—åˆ°çš„ä¿¡å·ä¸ºï¼š
$$I_{p}(t) = -\frac{1}{2}D(t)sin(Ï‰_{e}t + Î¸_{e})$$

$$Q_{p}(t) = \frac{1}{2}D(t)cos(Ï‰_{e}t + Î¸_{e})$$

å…¶ä¸­ 
$$Ï‰_{e}= Ï‰_{i}-Ï‰_{o}, Î¸_{e}=Î¸_{i}-Î¸_{o}$$

å°†IQè·¯ä¿¡å·ä½•åœ¨ä¸€èµ·å†™æˆå‘é‡çš„å½¢å¼ï¼š

$$r_{p}(t) = I_{p}(t) + jQ_{p}(t) = D(t)e^{jÏ‰_{e}t+Î¸_{e}} = A_{p}(t)e^{j \phi _{e}t}$$

å¯ä»¥çœ‹åˆ°ç»è¿‡ä½é€šæ»¤æ³¢ä¹‹åçš„å¤æ•°ä¿¡å·å½“ä¸­ç›¸ä½è¡¨ç¤ºå½“å‰è¾“å…¥ä¸è¾“å‡ºä¿¡å·çš„ç›¸ä½å·®
![å¤æ•°å‘é‡](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/å¤æ•°å‘é‡.png)

é€šè¿‡IQè·¯æ±‚åæ­£åˆ‡å³å¯ä»¥æ±‚å¾—å½“å‰çš„ç›¸ä½å·®

![å››è±¡é™åæ­£åˆ‡](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/å››è±¡é™åæ­£åˆ‡.png)

å¯é€šè¿‡å››è±¡é™åæ­£åˆ‡å‡½æ•°é‰´ç›¸æ³•å®Œæˆé‰´ç›¸å’Œåˆ¤å®š Ip(t) æ­£è´Ÿå·ã€‚

å››è±¡é™åæ­£åˆ‡ arctan2 æ‰€è¿”å›çš„è§’åº¦å€¼åœ¨âˆ’Ï€å’Œ+Ï€ä¹‹é—´ã€‚

äº‹å®ä¸Š,å››è±¡é™åæ­£åˆ‡å‡½æ•°è®¤å®šç›¸é‡ rp(t)çš„å¹…å€¼ Ap(t) å¿…å®šä¸ºä¸€ä¸ªæ­£æ•°,å¦åˆ™å‡½æ•°å°†å¹…å€¼ä¸­çš„è´Ÿå·è½¬æ¢ä¸º 180Â°(æˆ–-180Â°)çš„ç›¸ä½å·®å¼‚æ·»åŠ è¿›çœŸæ­£çš„ç›¸ä½å·®å¼‚ä¹‹ä¸Š,åŒæ—¶å¹…å€¼å˜ä¸ºæ­£æ•°ã€‚
å¦‚æœå››è±¡é™åæ­£åˆ‡è®¡ç®—çš„ç›¸ä½è§’ä½äºç¬¬ä¸€æˆ–ç¬¬å››è±¡é™,é‚£ä¹ˆD(t)ä¸º+1,å¹¶ä¸”è®¡ç®—å‡ºçš„ç›¸ä½å·®å¼‚å€¼ä¸ºè¿™ä¸€æ—¶åˆ»çš„é‰´ç›¸ç»“æœ;

å¦‚æœç›¸ä½è§’ä½äºç¬¬äºŒæˆ–ç¬¬ä¸‰è±¡é™,é‚£ä¹ˆD(t)ä¸º-1,å¹¶ä¸”ä»è¯¥ $\phi _{e}(t)$ä¸­æ‰£é™¤ 180Â°ç›¸ä½è·³å˜åçš„å€¼æ‰æ˜¯è¿™ä¸€æ—¶åˆ»çš„é‰´ç›¸ç»“æœã€‚

å¦‚æœå‘é‡çš„å®éƒ¨ä¸ºè´Ÿ,è™šéƒ¨ä¸ºæ­£éœ€è¦-pi;å®éƒ¨ä¸ºè´Ÿè™šéƒ¨ä¸ºè´Ÿéœ€è¦+pi;å¦‚æœæ—¶é’Ÿå››è±¡é™
çš„é‰´ç›¸å™¨éœ€è¦åšä»¥ä¸Šå¤„ç†å¾—åˆ°å½“å‰é‰´ç›¸ç»“æœã€‚

## é‰´ç›¸å™¨çš„å…·ä½“æ­¥éª¤
å‡å¦‚é”é¢‘ç¯çš„ç›¸å¹²ä¸æ­£äº¤æ”¯è·¯åœ¨ç¬¬nå†å…ƒåˆ†åˆ«è¾“å‡ºç›¸å¹²ç§¯åˆ†å€¼ğ¼ğ‘(ğ‘›)ä¸ğ‘„ğ‘(ğ‘›)ï¼Œç›¸åº”çš„å››
è±¡é™ç›¸ä½å·®å¼‚è§’ä¸ºâˆ…ğ‘’(ğ‘›)ï¼Œç¬¬ n-1 å†å…ƒçš„ç›¸ä½å·®å¼‚è§’ä¸ºâˆ…ğ‘’(ğ‘›âˆ’1)ï¼Œé‚£ä¹ˆè§’é¢‘ç‡è¯¯å·®ğœ”ğ‘’(ğ‘›)å¯
ä»è¿™ä¸¤ä¸ªå†å…ƒçš„ç›¸ä½å˜åŒ–ä¸­ä¼°ç®—å‡ºæ¥ã€‚

![ç›¸ä½å˜åŒ–æ±‚å–è§’é¢‘ç‡](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/ç›¸ä½å˜åŒ–æ±‚å–è§’é¢‘ç‡.png)

å…¶ä¸­ï¼Œ*t(ğ‘›)âˆ’t(ğ‘›âˆ’1)* ä¸ºç›¸å¹²ç§¯åˆ†æ—¶é—´ï¼Œè§’é¢‘ç‡ä¸é¢‘ç‡å·®å¼‚çš„å…³ç³»ä¸ºğœ”=2ğœ‹ğ‘“ã€‚ åœ¨åæ ‡è½´ä¸Šè¡¨ç°è¿™ä¸ªç›¸ä½æ±‚å–çš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ç›¸ä½é‰´åˆ«è¿‡ç¨‹](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/ç›¸ä½é‰´åˆ«è¿‡ç¨‹.png)

å…¶ä¸­æœ‰ä¸¤ä¸ªå‘é‡rp(n), rp(n-1)ï¼Œåˆ†åˆ«è¡¨ç¤ºæŸä¸€é‰´åˆ«æ—¶åˆ»å’Œä¸Šä¸€é‰´åˆ«æ—¶åˆ»çš„å‘é‡ï¼Œä¸¤è€…ä¹‹é—´çš„å¤¹è§’å³ä¸ºç›¸ä½çš„å˜åŒ–ã€‚é€šè¿‡æ±‚å–ä¸¤ä¸ªä¿¡å·çš„å…±è½­ç›¸ä¹˜å¯ä»¥å¾—åˆ°ä¿¡å·çš„å¹…åº¦å’Œç›¸ä½å·®çš„å…³ç³»ï¼š

![å…±è½­ç›¸ä¹˜](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/å…±è½­ç›¸ä¹˜.png)

äºæ­¤åŒæ—¶ï¼Œè¿˜å¯ä»¥å¾—åˆ°ä¿¡å·çš„ç‚¹ç§¯å‰ç§¯ï¼Œå¦‚ä¸‹æ‰€ç¤º

![ç‚¹ç§¯å‰ç§¯](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/ç‚¹ç§¯å‰ç§¯.png)

é€šè¿‡æ¯”å¯¹ä¿¡å·çš„ç‚¹ç§¯å‰ç§¯ä¸éš¾å‘ç°å’Œå…±è½­ç›¸ä¹˜çš„è”ç³»ï¼Œä»”ç»†è§‚å¯Ÿå³å¯å‘ç°å…¶ä¸­å…³äºç›¸ä½å·®çš„è®¡ç®—æ–¹æ³•ã€‚

![é‰´åˆ«å™¨å…¬å¼](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/é‰´åˆ«å™¨å…¬å¼.png)

ä¸Šé¢çš„å…¬å¼ï¼Œæ±‚å¾—å‡ºæ¥çš„æ˜¯è§’é¢‘ç‡ï¼Œå¯¹äºé¢‘ç‡åªéœ€è¦å’Œè§’é¢‘ç‡è¿›è¡Œä¸€ä¸ª2*piçš„è¿ç®—å³å¯ã€‚

ä¸€ä¸ªé‰´ç›¸å™¨çš„æœºæ„å¯ä»¥å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![é‰´ç›¸å™¨](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/phase_detector.png)

# ç¯è·¯æ»¤æ³¢å™¨
å…³äºç¯è·¯æ»¤æ³¢å™¨ï¼Œåœ¨è¿™é‡Œä¸ä»‹ç»å…¶ä¸­çš„å…·ä½“å†…å®¹ï¼Œåªä»‹ç»ä¸€ä¸‹ç¯è·¯çš„ç»“æ„å³å¯ä¸€ä¸ªäºŒé˜¶ç¯è·¯æ»¤æ³¢å™¨çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
å¯ä»¥çœ‹åˆ°é¦–å…ˆæœ‰ä¸€ä¸ªå¢ç›Šï¼Œç„¶ååˆ†æˆä¸¤æ¡ä¹‹è·¯ï¼Œä¸€æ¡æ”¯è·¯å¯¹åº”ä¸€æ¬¡ç§¯åˆ†ï¼Œä¸€ä¸ªæ”¯è·¯å¯¹äºä¸€ä¸ªå¢ç›Šï¼Œä¸¤æ¡æ”¯è·¯ä¹‹å’Œæ„æˆäº†PLLçš„è¾“å‡ºã€‚

![äºŒé˜¶loop_filter](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/äºŒé˜¶loop_filter.png)

å¯ä»¥çœ‹åˆ°åœ¨äºŒé˜¶PLLå½“ä¸­ï¼Œæœ‰ä¸€ä¸ªç§¯åˆ†å™¨ï¼Œåœ¨ç¦»æ•£äº‹ä»¶å½“ä¸­ï¼Œè¿™ä¸ªç§¯åˆ†å™¨å¯ä»¥æœ‰å¦‚ä¸‹ä¸¤ç§è¡¨ç°å½¢å¼ï¼š

![ç§¯åˆ†ç´¯åŠ æ¨¡å‹](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/ç§¯åˆ†ç´¯åŠ æ¨¡å‹.png)

![ç§¯åˆ†ç´¯åŠ æ¨¡å‹](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/ç§¯åˆ†åŒçº¿æ€§å˜æ¢.png)
å…¶ä¸­Tsæ˜¯ç¯è·¯æ›´æ–°çš„å‘¨æœŸï¼Œå°±æ¯”å¦‚ä¸Šé¢åœ¨è¿›è¡Œå‡å€¼æ»¤æ³¢æ—¶æ‰€éœ€è¦çš„ç´¯åŠ çš„å‘¨æœŸï¼Œå°±æ˜¯ç¯è·¯çš„æ›´æ–°çš„å‘¨æœŸï¼Œåœ¨PLLçš„è¿™ä¸€ä¹‹è·¯ä¸Šï¼Œéœ€è¦ä¹˜ä¸Šè¿™æ®µæ—¶é—´ã€‚

åœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨åŒçº¿æ€§å˜æ¢çš„æ¨¡å‹ã€‚

![äºŒé˜¶loop_filter](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/äºŒé˜¶loop_filter_åŒçº¿æ€§å˜æ¢.png)
## ç¯è·¯æ»¤æ³¢å™¨å‚æ•°è®¡ç®—
å…³äºä¸åŒé˜¶æ•°çš„ç¯è·¯æ»¤æ³¢å™¨ï¼Œå…¶å¯¹åº”çš„å…³é”®å‚æ•°æ˜¯ä¸ä¸€æ ·çš„ï¼Œåœ¨è¿™é‡Œå…ˆä»‹ç»äºŒé˜¶ç¯è·¯æ»¤æ³¢å™¨çš„å‚æ•°ï¼Œåœ¨ä¹‹åçš„åšå®¢å½“ä¸­å†ä»‹ç»ä¸‰é˜¶ç¯è·¯æ»¤æ³¢çš„å‚æ•°ã€‚
$$ é˜»å°¼ç³»æ•° \xi=0.707 $$
$$ a2 = 2*\xi $$
$$ ç‰¹å¾é¢‘ç‡ w_{n} ä¸å™ªå£°å¸¦å®½B_{L}çš„å…³ç³»ï¼š B_{L}= \frac{w_{n}}{2}(\xi+\frac{1}{4\xi})$$

åœ¨å®é™…çš„è®¾è®¡ä¸­ï¼Œåªéœ€è¦çŸ¥é“ç¯è·¯èƒ½å¤Ÿå¿å—çš„å™ªå£°å¸¦å®½ï¼Œå°±èƒ½å¤Ÿå¾ˆå®¹æ˜“çš„æ±‚å‡ºa2,å’Œç‰¹å¾é¢‘ç‡ã€‚

# matlabå®ä¾‹

```m
clc;
close all;
clear all;

%% parameter define
SAMP_RATE = 8.184e6;    % sample rate
IF_FREQ   = 2.046e6;    % inner frequency 2.046M 
SOURCE_DATA_LEN = 204800;  % the source data num
DATA_RATE = IF_FREQ/16; % data rate
SAMP_LEN  = SOURCE_DATA_LEN*(SAMP_RATE/DATA_RATE);
MEAN_FILTER_LEN = 32;   % mean filter length

TX_AMP = 1;
ROM_DEPTH = 4096;
TX_CARRIER_FREQ = IF_FREQ; % carrier frequency
TX_FREQ_CTRL_WORD = TX_CARRIER_FREQ * 2^32/ SAMP_RATE; % tx frequency control word

RX_AMP = 2048;
FREQ_OFFSET = 100; % frequency offset 100Hz
RX_FREQ_CTRL_WORD =  (TX_CARRIER_FREQ + FREQ_OFFSET)* 2^32/ SAMP_RATE;

% calculate the order2 loop filter parameter
RATIO = 0.707; % damping ratio
NOISE_BW = 50; % noise band width 
WN = 2*NOISE_BW/(RATIO+(1/(4*RATIO))); %BL=WN*(RATIO+(1/(4*RATIO)))/2
A2 = 2*RATIO;


%% generate bpsk modulation data
% source_data ==> BPSK mod
% generate source data
source_data = rand(1, SOURCE_DATA_LEN); % generate test source data
source_data(source_data < 0.5) = -1;
source_data(source_data >= 0.5) = 1;    
source_data = repelem(source_data, 1, SAMP_RATE/DATA_RATE); % upsample  signal source data to sample rate 

% generate carrier wave


rom_addr = 0: 1/ROM_DEPTH: 1-1/ROM_DEPTH;
carrier_wave_cos = RX_AMP*cos(2*pi*rom_addr);
carrier_wave_sin = RX_AMP*sin(2*pi*rom_addr);
% bpsk modulation
bpsk_mod = zeros(1,SAMP_LEN);
rom_index = 1;
phase_accumulator = 0;

for i=1:SAMP_LEN
    %bpsk modulation
    if(source_data(i) == -1)
        bpsk_mod(i) = -carrier_wave_cos(rom_index);
    else
        bpsk_mod(i) = carrier_wave_cos(rom_index);
    end

    phase_accumulator = phase_accumulator + TX_FREQ_CTRL_WORD;
    if(phase_accumulator > 2^32)
        phase_accumulator = phase_accumulator - 2^32;
    end

    rom_index = round(phase_accumulator/2^20);
    if(rom_index == 0)
        rom_index = 1;
    end
end

% plot the bpsk result
figure(1);
plot(1:1024, bpsk_mod(1:1024), 'r', 1:1024, source_data(1:1024),'b');
axis([0, 1024, -2, 2]);
legend('bpsk mod', 'source data');
title("BPSK modulation");

%% bpsk demodulation using pll
% the demodulation steps
% 1. iq demod, using the iq demodulation to get the iq data, the receiver lo_freq is coming for nco
% 2. low pass the demod signal to filter out high frequency(using mean filter )
% 3. phase detect, calculate the phase error and generate the frequency error
% 4. loop filter parameter calculate
% 5. drive the nco to generate local carrier frequency
rom_index = 1;          % rom index
mean_cal_index = 1;
i_data=0; q_data=0;     % i/q demod data
i_acc =0; q_acc =0;     % i/q accumulate value
i_mean=1; q_mean=1;     % mean value of i/q samples
p_dot =1; p_cross=1;    % dot/cross value of 2 vectors
delta_phi = 0;          % phase error
freq_err = 0;           % freq error
phase_accumulator = 0;  % clear the phase accumulator
freq_err_out = zeros(1,SAMP_LEN);
demod_i = zeros(1,SAMP_LEN);
demod_q = zeros(1,SAMP_LEN);
freq_err_control_word = 0;
freq_k1_acc_t = 0; freq_k1_acc = 0;
freq_k2 =0;
loop_out = 0; loop_out_t=0;

for i=1:SAMP_LEN
    % mixing
    i_data = bpsk_mod(i)*carrier_wave_cos(rom_index);
    q_data = -bpsk_mod(i)*carrier_wave_sin(rom_index);

    %% prepare mean filter(calculate MEAN_FILTER_LEN samples)
    % accumulate the samples
    i_acc = i_acc + i_data;
    q_acc = q_acc + q_data;
    if (mean_cal_index == MEAN_FILTER_LEN)
        i_mean_t = i_mean;
        q_mean_t = q_mean;
        % calculate mean value
        i_mean = i_acc/MEAN_FILTER_LEN;
        q_mean = q_acc/MEAN_FILTER_LEN;
        % clean accumulator
        i_acc = 0;
        q_acc = 0;

        %% phase detector(using vector)
        p_dot = i_mean*i_mean_t + q_mean*q_mean_t;
        p_cross = i_mean_t*q_mean - q_mean_t*i_mean;

        % using atan2 to calculate the phase
        if (p_dot == 0) % x=0
            delta_phi = atan2(p_cross, 1); %avoid divide 0
        else
            delta_phi = atan2(p_cross, p_dot);
        end

        % determine the phase trough quadrant 
        if (p_dot < 0 && p_cross > 0) % second quadrant
            delta_phi = delta_phi - pi;
        elseif (p_dot < 0 && p_cross < 0) % third quadrant 
            delta_phi = delta_phi + pi;
        elseif (p_cross == 0) % x axis
            delta_phi = 0;
        end

        % calculate the frequency error 2*pi*f=delta_phi/delta_t
        freq_err = (delta_phi/(MEAN_FILTER_LEN/SAMP_RATE))/(2*pi);

        %% loop filter
        freq_detector = freq_err/RX_AMP;    % 1/K phase detector gain

        % loop filter path 1
        freq_k1_acc_t = freq_k1_acc;
        freq_k1_acc = freq_detector*(WN^2)*(MEAN_FILTER_LEN/SAMP_RATE) + freq_k1_acc_t;
        freq_k1 = (freq_k1_acc + freq_k1_acc_t)/2;
        % loop filter  path 2
        freq_k2 = freq_detector*WN*A2;      

        % loop filter out
        loop_out = freq_k1 + freq_k2;

        % speed up order2 pll lock
        % loop_out_t = loop_out;
        % loop_out = freq_k1 + freq_k2 + loop_out_t;
        freq_err_control_word = (loop_out*2^32)/SAMP_RATE;

        mean_cal_index = 0;
    end
    mean_cal_index = mean_cal_index + 1;

    %% NCO control using loop filter out value
    phase_accumulator = phase_accumulator + RX_FREQ_CTRL_WORD + freq_err_control_word;
    if(phase_accumulator > 2^32)
        phase_accumulator = phase_accumulator - 2^32;
    end

    rom_index = round(phase_accumulator/2^20);
    if(rom_index == 0)
        rom_index = 1;
    end

    %% watch the output
    freq_err_out(i) = freq_err_control_word;
    demod_i(i) = i_mean;
    demod_q(i) = q_mean;

end

%figure;
subplot(2,1,1);
plot(freq_err_out);
title(['é¢‘ç‡å¹³å‡å€¼=',num2str((sum(freq_err_out(1200:end))/(SAMP_LEN-1200))*SAMP_RATE/2^32),'é¢‘ç‡è¯¯å·®',num2str((FREQ_OFFSET-(sum(freq_err_out(1200:end))/(SAMP_LEN-1200))*SAMP_RATE/2^32))]);
subplot(2,1,2);
plot(demod_i,'r');  % 
hold on;
plot(source_data*1e6, 'b');
title('çº¢è‰²æ˜¯è§£è°ƒæ•°æ®');
```
![é”é¢‘ç¯è·¯æœªé”å®š](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/é”é¢‘ç¯è·¯æœªé”å®š.png)

![é”é¢‘ç¯è·¯å·²é”å®š](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/é”é¢‘ç¯è·¯å·²é”å®š.png)

![è§£è°ƒæ•°æ®å­˜åœ¨ç›¸ä½åç§»](åŒ—æ–—å«æ˜Ÿå®šä½-5-äºŒé˜¶é”é¢‘ç¯è·¯/è§£è°ƒæ•°æ®å­˜åœ¨ç›¸ä½åç§».png)
